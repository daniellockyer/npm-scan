name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

  deploy:
    needs: typecheck
    runs-on: ubuntu-latest
    env:
      SSH_PORT: ${{ secrets.HETZNER_SSH_PORT || '22' }}
      HETZNER_HOST: ${{ secrets.HETZNER_HOST }}
      HETZNER_USER: ${{ secrets.HETZNER_USER }}
      HETZNER_DEPLOY_PATH: ${{ secrets.HETZNER_DEPLOY_PATH }}
      PM2_APP_NAME: ${{ secrets.PM2_APP_NAME || 'npm-scan' }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.HETZNER_SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.HETZNER_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${SSH_PORT}" -H "${HETZNER_HOST}" >> ~/.ssh/known_hosts
          fi

      - name: Sync files to server
        shell: bash
        run: |
          rsync -az --delete \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".github/" \
            --exclude "metadata/" \
            -e "ssh -p ${SSH_PORT}" \
            ./ "${HETZNER_USER}@${HETZNER_HOST}:${HETZNER_DEPLOY_PATH}/"

      - name: Install dependencies and restart with PM2
        shell: bash
        run: |
          ssh -p "${SSH_PORT}" "${HETZNER_USER}@${HETZNER_HOST}" \
            "HETZNER_DEPLOY_PATH='${HETZNER_DEPLOY_PATH}' PM2_APP_NAME='${PM2_APP_NAME}' TELEGRAM_BOT_TOKEN='${TELEGRAM_BOT_TOKEN}' TELEGRAM_CHAT_ID='${TELEGRAM_CHAT_ID}' bash -s" \
            < .github/scripts/deploy_remote.sh

